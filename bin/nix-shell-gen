#!/bin/bash

COMPILER='ghc822'
HASKVER='_8_2'
NIXPKGS='import <darwin> {}'

HASKPKGS="haskellPackages${HASKVER}"
PKGNAME=$(basename "$PWD")

START="$PWD"
while [[ "$PWD" != "/" && ! -f default.nix ]]; do
    cd ..
done

if [[ "$PWD" = "/" ]]; then
    cd "$START"
    while [[ "$PWD" != "/" && ! -d .git && ! -f .git ]]; do
        cd ..
    done
fi

if [[ "$PWD" = "/" ]]; then
    echo "Error: Could not find default.nix or .git"
    exit 1
fi

read -r -d '' INPUT <<- EOM
let pkgs = (${NIXPKGS}).pkgs;
in pkgs.packageDeps
     "${PKGNAME}"
     "${COMPILER}"
     pkgs.${HASKPKGS}
     (builtins.toPath "$PWD")
EOM

exec nix-shell -p "$INPUT" "$@"

#!/bin/bash -e

set -eo pipefail
IFS=$'\n\t'

function finish {
    if [[ -f default.nix.bak ]]; then
        mv default.nix.bak default.nix
    fi
}

ARGS="$1"

if [[ -z "$ARGS" && -f default.nix ]]; then
    trap finish EXIT INT TERM ERR
    mv default.nix default.nix.bak
fi

function realize {
    build -Q | cachix push nix-johnw
    shell -Q --command true
}

realize

if [[ -z "$ARGS" ]]; then
    finish
    if [[ -f default.nix ]]; then
        realize
    fi
fi
